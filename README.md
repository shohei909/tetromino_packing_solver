# ツール概要

テトリスの地形を与えると、その地形がどんな置き方によって作れるかを逆算してくれるツールです。
つまり、テトリス用に特化したポリオミノ敷き詰め問題解答ツールです。

https://shohei909.github.io/tetromino_packing_solver/

から利用できます。


# 背景

テトリスのテンプレなどを考える上で逆算という手法がある。

例えば、3巡目の開始時時点での良い地形を考えてから、その地形を組める1巡目と2巡目を考える。

solution-finder のような地形与えるとその組み方とセットアップ率を出してくれるツールはあるが、速度的には1巡程度の逆算が限界で、2巡分を逆算しようとすると相当な時間がかかる。ライン消去やセットアップ確率を出さない代わりに、2巡・3巡分の置き方をリストアップしてくれるツールを作りたかった。


# アイデアノート

このツールを作る上で使用したアイデアのリストです。


## 領域の分割①
二つの領域が分割されているかを判定する。

完全に分割されているなら適当な灰色マス1を選んで、DFS (深さ優先探索) してつながっている範囲を見つければひとつながりのグループが取得できる。これがグループ分けがしてないマスが無くなるまで繰り返す。


## 領域の分割②
関節点を見つけて領域を分割する。この場合の関節点とは、そのマスを削除したら領域が分割されるようなマスを指す。これは lowlink 法で見つけられる。

* 間接点を削除した時に生まれる2つの領域のうち片方の領域がちょうど 4 の倍数のマス数だった場合、その境界で領域を分割して良い。
* 間接点を削除した時に生まれる2つの領域のうち片方の領域が、4 の倍数 - 1マス だった場合、の最大で3通りの分割ができるので、3通りの分割を行って問題を場合分けする。
* 元の領域マス数が4の倍数なら、上記のどちらかに当てはまる

## 領域サイズのフィルター

ある領域のサイズが4の倍数でなかった場合、その領域を埋めることはできない。

## 使用ミノの列挙

各ミノの使用回数の上限下限リストと、領域分のミノ数が与えらえるので、使用するミノとしてのありうる組み合わせを全列挙する。これは、DFSで出来る。

## パリティによりあり得ないミノの組み合わせを除外する

市松パリティがTミノの使用回数と一致しないものを除外
Tミノの使用回数0回で、縦パリティがJLの使用回数と一致しないものを除外

## 領域の対称性の利用

領域が対称なら1つだけミノの向きを制限する。この時利用する対称性は180°ごとの点対称性と90°ごとの点対称性。ミノにも対称性があるので、この時向きの制限をするのは、なるべく対称性の低いものとする（T・L・J → I・S・Z → O の順）


## 領域へのミノの敷き詰め

### 領域へのミノの敷き詰め案1（Z3）

SMTソルバーの[Z3](https://github.com/Z3Prover/z3)を使用して解く案。

前提として、ミノ内の4つのブロックを分けて考える

基本的な変数は

* ミノ内の各ブロックの位置を表すX座標・Y座標の変数。(2 × 4 × ミノ数の変数)

必須の制約は

* 有効な領域の座標は、ミノのブロックの XY 座標のうち 1 つだけと一致する
* 同じミノ内のブロックの XY 座標の関係性が、ミノの回転によって生まれる 4 種類の形状のいずれかに一致する

対称性を除去する制約は
* 同種のミノはIDの若いミノの方がXY座標の値が小さい

実装した結果、結構遅かったのでボツ寄り。4×6 の敷き詰めに対して、8秒程度かかっていた。


### 領域へのミノの敷き詰め案2（splr）

SATソルバー、例えば [splr]() を使って解く

ミノ内の4つのブロックを分けない

* 変数はあるマスに特定の種類のミノが存在しているかの Bool (ミノの数×マス数)

必須の制約は

* あるマスに存在しているミノは一つ
* ミノごとに有効な配置方法を全列挙して、そのいずれかが満たされること
  * 無効な配置方法が枝刈りできるのが強そう

対称性を除去する制約は簡単には張れない
splr を自前で wasm 出力して使えるようにする必要があるのが面倒そう

### 領域へのミノの敷き詰め案3（DLX）

Algorithm X + Dancing Links（DLX）を使って解く。

* 前提として、事前の使用ミノの振り分けは不要になる
  * でも、パリティによる枝刈りや並列化ができるから事前に振り分けた方が高速そう
* 種類が同じ複数ミノは行はまとめる。行は残りミノ数を使いきったら削除する。
* 各ミノの種類において、必須分と使っても使わなくても良い分は別種類と見なす
  * 必須分を優先的に使うような工夫が要る
* 各種類ごとに種類を表すダミー列を用意する
* 必須列をリンクした行を用意し、その行が空になったら完了（=ヘッダー行）
  * 逆にここにリンクしないことで、覆わなくても良いマスを表現できる

バックトラックは列の削除時にその列の要素がヘッダー行のみになったとき

#### DLX + ヒューリティクス
DLX は、探索順を自前で制御できるので、その探索順に対してヒューリティクスを導入できる
* 列選択ヒューリティクス
* 行選択ヒューリティクス
* 枝刈りヒューリティクス
   ** 16色パリティによる枝刈りが可能そう
   

## ある1ミノを置いた状態で残りが敷き詰め不可能だった場合に、その置き方を除外する
前述の案2や案3では、1ミノの置き方を全通りリストアップする過程がある。この1ミノによって領域が不正に分割されていないかのチェックを行って、不正に分割されてたら、その置き方を除外する

## 並列化
分割した領域や使用するミノの組み合わせごとで、問題を分割してあるので並列化が可能

## 解答の連結時の動的計画法
分割した問題を解決していく過程で、そこまでで使用したミノとフィールドの形状が一致する場合がある。この際、その後の問題を重複して解かないように、ミノ・フィールドからキーを作って、途中までの解答を辞書に格納していく
